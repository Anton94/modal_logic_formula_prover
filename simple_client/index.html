<!DOCTYPE html>
<html>
	<head>
		<link rel="shortcut icon" type="image/png" href="./img/home-icon.png"/>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
		<script src="https://d3js.org/d3.v4.js"></script>

		<script>
			var IP_ADDRESS = "http://localhost:34567/";
			var valid_op_id = null;

			// since now we are only posting tasks, these requests will be fast enough and 
			// we can make them synchronous thus returning the result as soon as it comes.
			// this should be done better in an upcoming version.
			function is_satisfiable(formula) {
				document.getElementById("is_satisfied_output").innerHTML = "";
				document.getElementById("output").innerHTML = "";

				$.post(IP_ADDRESS + "satisfy", { formula: formula })
		            .done(function( data ) {
		              console.log("good");
		            });
			}

			function post_task(formula, algorithm_type, formula_filters) {
				var params =  
					"?algorithm_type=" + algorithm_type +
					"&formula_filters=" + formula_filters;
				$.post(IP_ADDRESS + "task" + params, formula)
		            .done(function( data ) {
		              valid_op_id = data;
		            });
		            // on error change_computing_components_availability
			}

			function ping_task(op_id, timer_id) {
				var params = "?op_id=" + valid_op_id;
				$.post(IP_ADDRESS + "ping" + params, null)
		            .done(function( data ) {
		            	// depending on the data return RUNNING or CANCELED or FINISHED...
		              console.log(data);
		              var jsonified = JSON.parse(data.replace(/'/g, "\""));
		              if (jsonified["status"] == "FINISHED" ) {
			              clearInterval(timer_id);
			              valid_op_id = null;
						  document.getElementById('formula_output').innerText = "The formula is : " + jsonified["is_satisfied"];
						  graphis = transform_contacts_to_graph(jsonified["contacts"]);
			              do_visualization(graphis);
		           	      change_computing_components_availability(true)
		              } else if (jsonified["status"] == "CANCELED") {
			              clearInterval(timer_id);
			              valid_op_id = null;
						  document.getElementById('formula_output').innerText = "The Task was Canceled.";
		           	  	  change_computing_components_availability(true)
			              // populate the output that the formula was canceled
		              } else if (jsonified["status"] == "RUNNING") {
		              	  // populate the verbose output  
		              }
		            });
			}

			function cancel_task(op_id, timer_id) {
				var params = "?op_id=" + valid_op_id; 
				$.post(IP_ADDRESS + "cancel" + params, null)
		            .done(function( data ) {
		            	// return true if success, return false if the task was already canceled
		              console.log(data);
		              var jsonified = JSON.parse(data.replace(/'/g, "\""));
		              valid_op_id = null;
		              change_computing_components_availability(true);
		            });
			}

			function create_task(algorithm_type) {
				var formula = document.getElementById('formula').value;
				var formula_filters = [];

				// if (!(algorithm_type === 'SLOW_MODEL' || algorithm_type === 'FAST_MODEL' || algorithm_type === 'CONNECTIVITY' || algorithm_type === 'BRUTEFORCE_MODEL'])) {
				// 	console.log(algorithm_type + " not in " + ['SLOW_MODEL', 'FAST_MODEL', 'CONNECTIVITY', 'BRUTEFORCE_MODEL']);
				// 	return;
				// }

				change_computing_components_availability(false);
				post_task(formula, algorithm_type, formula_filters);

				function myFunction() {
					var timer_id = setInterval(function(){
						ping_task(valid_op_id, timer_id);
					}, 2000);
				};
				myFunction();
				// set ping on every few seconds it is best to have something like this for the ping delay [1, 2, 5, 7, 10, 10, ...
				// on ping result FINISHED show the result probably in the output area.
			}

			function change_computing_components_availability(enable) {
				 var elems = document.getElementsByClassName("computing_element");
				for(var i = 0; i < elems.length; i++) {
				    elems[i].disabled = !enable;
				}
			}

			function transform_contacts_to_graph(contacts) {
				nodes_temp = [...Array(contacts.length).keys()]

				nodes = []
				for (x in nodes_temp) {
					nodes.push({"id": x, "name": "A" + x});
				}


				links = [];

				for (i = 0; i < contacts.length; ++i) {
					for (j = 0; j < contacts[i].length && j <= i; ++j) {
						if (contacts[i][j] == "1") { 
							links.push({"source": i, "target": j});
				        }
				    }
				}

				return {"nodes" : nodes, "links": links}
			}

			function do_visualization(graph) {
			  d3.select("svg").empty();
			  d3.select("#visualization-graph").select("svg").remove();

			  var svg = d3.select("#visualization-graph")
			  	  .append("svg")
			  	  .attr('width', 1024)
			  	  .attr('height', 840)
			      .call(d3.zoom().on("zoom", function () {
			         svg.attr("transform", d3.event.transform)
			      })),
			      width = +svg.attr("width"),
			      height = +svg.attr("height");

			  var simulation = d3.forceSimulation()
			      .force("link", d3.forceLink().id(function(d) { return d.id; }))
			      .force("charge", d3.forceManyBody().strength(-90))
			      .force("center", d3.forceCenter(width / 2, height / 2))
			      .force('collision', d3.forceCollide().radius(function(d) {
			        return 25
			      }));

			  var link = svg.append("g")
			              .style("stroke", "#aaa")
			              .selectAll("line")
			              .data(graph.links)
			              .enter().append("line");

			  var node = svg.append("g")
			          .attr("class", "nodes")
			  .selectAll("circle")
			          .data(graph.nodes)
			  .enter().append("circle")
			        .attr("r", 6);

			  var label = svg.append("g")
			    .attr("class", "labels")
			    .selectAll("text")
			    .data(graph.nodes)
			    .enter().append("text")
			      .attr("class", "label")
			      .text(function(d) { return d.name; });

			  simulation
			    .nodes(graph.nodes)
			    .on("tick", ticked);

			  simulation.force("link")
			    .links(graph.links);

			  function ticked() {
			  	console.log("in Tick");
			  link
			      .attr("x1", function(d) { return d.source.x; })
			      .attr("y1", function(d) { return d.source.y; })
			      .attr("x2", function(d) { return d.target.x; })
			      .attr("y2", function(d) { return d.target.y; });

			  node
			       .attr("r", 20)
			       .style("fill", "#d9d9d9")
			       .style("stroke", "#969696")
			       .style("stroke-width", "1px")
			       .attr("cx", function (d) { return d.x - 5; })
			       .attr("cy", function(d) { return d.y - 5; });

			  label
			  		.attr("x", function(d) { return d.x - 13; })
			          .attr("y", function (d) { return d.y; })
			          .style("font-size", "20px").style("fill", "#4393c3");
			  }
			};
		</script>
		<style>
			code {
				font-size: 15px;
			}
			label {
				font-size: 15px;
			}
		</style>
		<style>
			.accordion {
			  background-color: #eee;
			  color: #444;
			  cursor: pointer;
			  padding: 18px;
			  width: 100%;
			  border: none;
			  text-align: left;
			  outline: none;
			  font-size: 15px;
			  transition: 0.4s;
			  margin-left: 20px;
			  margin-right: 20px;
			}

			.active, .accordion:hover {
			  background-color: #ccc; 
			}

			.panel {
			  padding: 0 18px;
			  display: none;
			  background-color: white;
			  overflow: hidden;
			  margin-left: 20px;
			  margin-right: 20px;
			}
		</style>
	</head>
	<body>
		<div id="formula_input" style="margin: 20px;">
			Formula:<br>
			<input id="formula" style="width: 100%; height: 20px;"/>
		</div>

		<div id="formula_filters" style="margin: 20px;">
			Formula Filters:<br>
			<input type="checkbox" id="myCheck"  onclick="myFunction()"> Filter 1<br>
			<input type="checkbox" id="myCheck"  onclick="myFunction()"> Filter 2<br>
			<input type="checkbox" id="myCheck"  onclick="myFunction()"> Filter 3<br>
			<input type="checkbox" id="myCheck"  onclick="myFunction()"> Filter 4<br>
		</div>

		<div id="algorith_buttons" style="margin: 20px;">
			Run algorithm:<br><br>
			<button onclick="create_task('SLOW_MODEL')" class="computing_element">SLOW MODEL</button>
			<button onclick="create_task('FAST_MODEL')" class="computing_element">FAST MODEL</button>
			<button onclick="create_task('CONNECTIVITY')" class="computing_element">CONNECTIVITY</button>
			<!-- Add killswitch which is only for development so that this line does not be present -->
			<button onclick="create_task('BRUTEFORCE_MODEL')" class="computing_element">BRUTEFORCE MODEL</button>
		</div>
		<div id="algorithm_cancelations" style="margin: 20px;">
			If the calculation takes too long, try to cancel it and it might help to optimize the input formula<br>
			<button onclick="cancel_task('valid_op_id')">CANCEL CALCULATION</button>
		</div>
		
		<div id="is_satisfied">
			<pre id="is_satisfied_output"></pre>
		</div>
		<h2 style="margin-left: 20px;">Output</h2>
		<button class="accordion">Result</button>
		<div class="panel">
			<div id="qqq">
				<pre id="formula_output"></pre>
			</div>
		</div>

		<button class="accordion">Verbose Output / Console</button>
		<div class="panel">
		  <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
		</div>

		<button class="accordion" style="margin-bottom: 20px;">Visualized Model</button>
		<div class="panel">
		 	<div id="visualization-graph">
		 	</div>
		</div>

		<script>
		var acc = document.getElementsByClassName("accordion");
		var i;

		for (i = 0; i < acc.length; i++) {
		  acc[i].addEventListener("click", function() {
		    this.classList.toggle("active");
		    var panel = this.nextElementSibling;
		    if (panel.style.display === "block") {
		      panel.style.display = "none";
		    } else {
		      panel.style.display = "block";
		    }
		  });
		}
		</script>

		<h2 style="margin-left: 20px;">Legend</h2>
		<code>F&nbsp;&nbsp;&nbsp;-&nbsp;<img src="img/bot.png" alt="Bottom"> - </code><label>False</label><br>
		<code>T&nbsp;&nbsp;&nbsp;-&nbsp;<img src="img/top.png" alt="Top"> - </code><label>True</label><br>
		<code>-&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp; &nbsp; </code><label>Unary Complement</label><br>
		<code>*&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp; &nbsp; </code><label>Boolean Intersection</label><br>
		<code>+&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp; &nbsp; </code><label>Boolean Union</label><br>
		<code>C&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp; &nbsp; </code><label>Contact, syntax:</label><code>&nbsp;C(T<sub>1</sub>,&nbsp;T<sub>2</sub>)</code><br>
		<code>&lt;=&nbsp;&nbsp;-&nbsp;≤ - </code><label>Part Of</label><br>
		<code>&amp;&nbsp;&nbsp;&nbsp;-&nbsp;<img src="img/and.png" alt="And"> - </code><label>Conjunction</label><br>
		<code>|&nbsp;&nbsp;&nbsp;-&nbsp;<img src="img/or.png" alt="Or"> - </code><label>Disjunction</label><br>
		<code>~&nbsp;&nbsp;&nbsp;-&nbsp;<img src="img/not.png" alt="Not"> - </code><label>Negation</label><br>
		<code>-&gt;&nbsp;&nbsp;-&nbsp;</code><label>Implication</label><br>
		<code>&lt;-&gt;&nbsp;-&nbsp;</code><label>Equivalence</label><br>


	</body>
</html>